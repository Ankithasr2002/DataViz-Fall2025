<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Massachusetts Geospatial Visualization</title>
    
    <!-- Load D3.js first -->
    <script src="./libs/d3.js"></script>
    
    <!-- Load TopoJSON second - TRY BOTH FILENAMES -->
    <script src="./libs/d3jstopojson.v1.js" onerror="this.onerror=null; this.src='./libs/d3jstopoison.v1.js'"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
            letter-spacing: -1px;
        }

        h3 {
            color: #7f8c8d;
            font-size: 1.3em;
            margin-bottom: 40px;
            text-align: center;
            font-weight: 400;
        }

        .error-box {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #ef5350;
            display: none;
        }

        .maps-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 30px;
        }

        .map-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .map-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 15px;
            text-align: center;
        }

        svg {
            display: block;
            margin: 0 auto;
        }

        path {
            stroke: #fff;
            stroke-width: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        path:hover {
            stroke: #2c3e50;
            stroke-width: 2px;
            filter: brightness(0.9);
        }

        path.highlighted {
            stroke: #2c3e50;
            stroke-width: 2.5px;
            filter: brightness(1.2);
        }

        .legend {
            display: flex;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .legend-gradient {
            width: 300px;
            height: 20px;
            margin: 0 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .legend-label {
            color: #555;
            font-weight: 500;
        }

        #tooltip {
            position: absolute;
            background: white;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 350px;
            z-index: 1000;
            font-family: sans-serif;
        }

        #tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .tooltip-content {
            font-size: 0.95em;
            color: #555;
            line-height: 1.6;
        }

        .gini-value {
            font-weight: 600;
            color: #e74c3c;
            font-size: 1.1em;
        }

        #lineChart {
            margin-top: 12px;
            border-top: 1px solid #ecf0f1;
            padding-top: 10px;
        }

        .axis text {
            font-size: 10px;
            fill: #666;
        }

        .axis path,
        .axis line {
            stroke: #ccc;
        }

        .line {
            fill: none;
            stroke: #3498db;
            stroke-width: 2.5px;
        }

        .dot {
            fill: #3498db;
            stroke: white;
            stroke-width: 2px;
        }
    </style>
</head>

<body>
    <div id="tooltip"></div>
    <div class="container">
        <h1>Massachusetts Towns: Population and Inequality Analysis</h1>
        <h3>ANKITHA</h3>

        <div id="errorBox" class="error-box"></div>

        <div class="maps-container">
            <div class="map-wrapper">
                <div class="map-title">MAP A: Population in 1980</div>
                <div class="fig1"></div>
                <div class="legend" id="legend1">
                    <span class="legend-label">Low</span>
                    <div class="legend-gradient" id="legendA"></div>
                    <span class="legend-label">High</span>
                </div>
            </div>

            <div class="map-wrapper">
                <div class="map-title">MAP B: Population Change (1980-2010)</div>
                <div class="fig2"></div>
                <div class="legend" id="legend2">
                    <span class="legend-label">Decrease</span>
                    <div class="legend-gradient" id="legendB"></div>
                    <span class="legend-label">Increase</span>
                </div>
            </div>

            <div class="map-wrapper">
                <div class="map-title">MAP C: Gini Index by County (2019)</div>
                <div class="fig3"></div>
                <div class="legend" id="legend3">
                    <span class="legend-label">Low Inequality</span>
                    <div class="legend-gradient" id="legendC"></div>
                    <span class="legend-label">High Inequality</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for DOM to be fully loaded
        window.addEventListener('DOMContentLoaded', function() {
            const errorBox = document.getElementById('errorBox');
            
            // Check if D3 loaded
            if (typeof d3 === 'undefined') {
                errorBox.style.display = 'block';
                errorBox.innerHTML = '<strong>ERROR:</strong> D3.js failed to load. Make sure d3.js is in the libs/ folder.';
                console.error('D3 is not defined');
                return;
            }

            // Check if TopoJSON loaded
            if (typeof topojson === 'undefined') {
                errorBox.style.display = 'block';
                errorBox.innerHTML = '<strong>ERROR:</strong> TopoJSON failed to load. Check that the file exists in libs/ folder.';
                console.error('TopoJSON is not defined');
                return;
            }

            console.log('Libraries loaded successfully!');
            console.log('D3 version:', d3.version);

            /*-------------------------------------------------------*/
            /*------------------- Settings --------------------------*/
            /*-------------------------------------------------------*/
            const svgWidth = 800;
            const svgHeight = 600;
            const margin = 30;

            const MA_counties = "./data/towns.topojson";
            const gini_index = "./data/gini_index.csv";

            /*-------------------------------------------------------*/
            /*-----------------Load and Process Data-----------------*/
            /*-------------------------------------------------------*/
            Promise.all([
                d3.json(MA_counties),
                d3.csv(gini_index)
            ]).then(data => {
                const topology_data = data[0];
                const csv_data = data[1];

                console.log('Data loaded! TopoJSON objects:', Object.keys(topology_data.objects));
                console.log('CSV rows:', csv_data.length);

                // Process Gini data
                const giniByCountyYear = {};
                csv_data.forEach(d => {
                    const fips = +d.id.replace('0500000US', '');
                    const year = +d.year;
                    const gini = +d['Estimate!!Gini Index'];

                    if (!giniByCountyYear[fips]) {
                        giniByCountyYear[fips] = {};
                    }
                    giniByCountyYear[fips][year] = gini;
                });

                // Convert topology to geojson
                const geojson = topojson.feature(topology_data, topology_data.objects.ma);

                /*-------------------------------------------------------*/
                /*--------------------- MAP A ---------------------------*/
                /*-------------------------------------------------------*/
                const svg1 = d3.select(".fig1").append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

                const projection1 = d3.geoMercator()
                    .fitSize([svgWidth - margin, svgHeight - margin], geojson);

                const geoPath1 = d3.geoPath().projection(projection1);

                const pop1980Values = geojson.features.map(d => d.properties.POP1980);
                const colorScale1 = d3.scaleSequential(d3.interpolateBlues)
                    .domain([d3.min(pop1980Values), d3.max(pop1980Values)]);

                createLegend('#legendA', colorScale1, d3.min(pop1980Values), d3.max(pop1980Values));

                svg1.selectAll("path")
                    .data(geojson.features)
                    .enter()
                    .append("path")
                    .attr("d", geoPath1)
                    .attr("fill", d => colorScale1(d.properties.POP1980))
                    .attr("data-town-id", d => d.properties.TOWN_ID)
                    .on("mouseenter", function(event, d) {
                        highlightTown(d.properties.TOWN_ID);
                    })
                    .on("mouseleave", function(event, d) {
                        unhighlightTown(d.properties.TOWN_ID);
                    });

                /*-------------------------------------------------------*/
                /*--------------------- MAP B ---------------------------*/
                /*-------------------------------------------------------*/
                const svg2 = d3.select(".fig2").append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

                const projection2 = d3.geoMercator()
                    .fitSize([svgWidth - margin, svgHeight - margin], geojson);

                const geoPath2 = d3.geoPath().projection(projection2);

                const popChangeValues = geojson.features.map(d => d.properties.POP2010 - d.properties.POP1980);
                const colorScale2 = d3.scaleDiverging(d3.interpolateRdYlGn)
                    .domain([d3.min(popChangeValues), 0, d3.max(popChangeValues)]);

                createLegend('#legendB', colorScale2, d3.min(popChangeValues), d3.max(popChangeValues));

                svg2.selectAll("path")
                    .data(geojson.features)
                    .enter()
                    .append("path")
                    .attr("d", geoPath2)
                    .attr("fill", d => colorScale2(d.properties.POP2010 - d.properties.POP1980))
                    .attr("data-town-id", d => d.properties.TOWN_ID)
                    .on("mouseenter", function(event, d) {
                        highlightTown(d.properties.TOWN_ID);
                    })
                    .on("mouseleave", function(event, d) {
                        unhighlightTown(d.properties.TOWN_ID);
                    });

                /*-------------------------------------------------------*/
                /*--------------------- MAP C ---------------------------*/
                /*-------------------------------------------------------*/
                const svg3 = d3.select(".fig3").append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

                const projection3 = d3.geoMercator()
                    .fitSize([svgWidth - margin, svgHeight - margin], geojson);

                const geoPath3 = d3.geoPath().projection(projection3);

                const countiesByFips = d3.group(geojson.features, d => d.properties.FIPS_STCO);

                const countyNames = {
                    25001: 'Barnstable County', 25003: 'Berkshire County',
                    25005: 'Bristol County', 25007: 'Dukes County',
                    25009: 'Essex County', 25011: 'Franklin County',
                    25013: 'Hampden County', 25015: 'Hampshire County',
                    25017: 'Middlesex County', 25019: 'Nantucket County',
                    25021: 'Norfolk County', 25023: 'Plymouth County',
                    25025: 'Suffolk County', 25027: 'Worcester County'
                };

                const countyFeatures = Array.from(countiesByFips).map(([fips, towns]) => {
                    return {
                        type: 'Feature',
                        properties: {
                            FIPS_STCO: fips,
                            gini2019: giniByCountyYear[fips] ? giniByCountyYear[fips][2019] : 0,
                            giniData: giniByCountyYear[fips] || {},
                            countyName: countyNames[fips] || 'Unknown'
                        },
                        geometry: {
                            type: 'MultiPolygon',
                            coordinates: towns.map(t => {
                                if (t.geometry.type === 'Polygon') {
                                    return [t.geometry.coordinates];
                                } else {
                                    return t.geometry.coordinates;
                                }
                            }).flat()
                        }
                    };
                });

                const gini2019Values = countyFeatures.map(d => d.properties.gini2019).filter(v => v > 0);
                const colorScale3 = d3.scaleSequential(d3.interpolateReds)
                    .domain([d3.min(gini2019Values), d3.max(gini2019Values)]);

                createLegend('#legendC', colorScale3, d3.min(gini2019Values), d3.max(gini2019Values));

                const tooltip = d3.select("#tooltip");

                svg3.selectAll("path")
                    .data(countyFeatures)
                    .enter()
                    .append("path")
                    .attr("d", geoPath3)
                    .attr("fill", d => colorScale3(d.properties.gini2019))
                    .on("mouseenter", function(event, d) {
                        d3.select(this)
                            .style("filter", "brightness(0.9)")
                            .style("stroke", "#2c3e50")
                            .style("stroke-width", "2.5px");

                        const giniData = d.properties.giniData;
                        const years = Object.keys(giniData).map(Number).sort();
                        const values = years.map(year => giniData[year]);

                        tooltip
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY + 15) + "px")
                            .classed("visible", true)
                            .html(`
                                <div class="tooltip-title">${d.properties.countyName}</div>
                                <div class="tooltip-content">
                                    <div><strong>2019 Gini Index:</strong> <span class="gini-value">${d.properties.gini2019.toFixed(4)}</span></div>
                                    <div id="lineChart"></div>
                                </div>
                            `);

                        if (years.length > 0) {
                            createLineChart(years, values);
                        }
                    })
                    .on("mousemove", function(event) {
                        tooltip
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY + 15) + "px");
                    })
                    .on("mouseleave", function() {
                        d3.select(this)
                            .style("filter", null)
                            .style("stroke", "#fff")
                            .style("stroke-width", "0.5px");

                        tooltip.classed("visible", false);
                    });

                console.log('All maps generated successfully!');

                /*-------------------------------------------------------*/
                /*---------------- Helper Functions ---------------------*/
                /*-------------------------------------------------------*/
                function highlightTown(townId) {
                    d3.selectAll(`[data-town-id="${townId}"]`)
                        .classed("highlighted", true);
                }

                function unhighlightTown(townId) {
                    d3.selectAll(`[data-town-id="${townId}"]`)
                        .classed("highlighted", false);
                }

                function createLineChart(years, values) {
                    const chartWidth = 300;
                    const chartHeight = 150;
                    const chartMargin = { top: 20, right: 10, bottom: 25, left: 40 };

                    const svg = d3.select('#lineChart')
                        .append('svg')
                        .attr('width', chartWidth)
                        .attr('height', chartHeight);

                    const xScale = d3.scaleLinear()
                        .domain([d3.min(years), d3.max(years)])
                        .range([chartMargin.left, chartWidth - chartMargin.right]);

                    const yScale = d3.scaleLinear()
                        .domain([d3.min(values) * 0.95, d3.max(values) * 1.05])
                        .range([chartHeight - chartMargin.bottom, chartMargin.top]);

                    svg.append('text')
                        .attr('x', chartWidth / 2)
                        .attr('y', 12)
                        .attr('text-anchor', 'middle')
                        .style('font-size', '11px')
                        .style('font-weight', '600')
                        .style('fill', '#34495e')
                        .text('Gini Index Trend (2010-2019)');

                    svg.append('g')
                        .attr('class', 'axis')
                        .attr('transform', `translate(0,${chartHeight - chartMargin.bottom})`)
                        .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.format('d')));

                    svg.append('g')
                        .attr('class', 'axis')
                        .attr('transform', `translate(${chartMargin.left},0)`)
                        .call(d3.axisLeft(yScale).ticks(5).tickFormat(d3.format('.3f')));

                    const line = d3.line()
                        .x((d, i) => xScale(years[i]))
                        .y(d => yScale(d));

                    svg.append('path')
                        .datum(values)
                        .attr('class', 'line')
                        .attr('d', line);

                    svg.selectAll('.dot')
                        .data(values)
                        .join('circle')
                        .attr('class', 'dot')
                        .attr('cx', (d, i) => xScale(years[i]))
                        .attr('cy', d => yScale(d))
                        .attr('r', 4);
                }

                function createLegend(selector, colorScale, min, max) {
                    const legendWidth = 300;
                    const legendHeight = 20;

                    const svg = d3.select(selector)
                        .append('svg')
                        .attr('width', legendWidth)
                        .attr('height', legendHeight);

                    const defs = svg.append('defs');
                    const gradient = defs.append('linearGradient')
                        .attr('id', selector.replace('#', '') + '-gradient');

                    const numStops = 10;
                    for (let i = 0; i <= numStops; i++) {
                        const t = i / numStops;
                        const value = min + t * (max - min);
                        gradient.append('stop')
                            .attr('offset', `${t * 100}%`)
                            .attr('stop-color', colorScale(value));
                    }

                    svg.append('rect')
                        .attr('width', legendWidth)
                        .attr('height', legendHeight)
                        .style('fill', `url(#${selector.replace('#', '')}-gradient)`);
                }

            }).catch(error => {
                errorBox.style.display = 'block';
                errorBox.innerHTML = `<strong>ERROR loading data:</strong> ${error.message}<br><br>
                    Make sure these files exist:<br>
                    - data/towns.topojson<br>
                    - data/gini_index.csv`;
                console.error('Data loading error:', error);
            });
        });
    </script>
</body>
</html>
